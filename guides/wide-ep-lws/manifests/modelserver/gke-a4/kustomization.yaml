apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../gke
patches:
  - target:
      kind: LeaderWorkerSet
      name: wide-ep-llm-d-decode
    patch: |-
      # As per https://github.com/vllm-project/vllm/issues/25597 B200 devices may need
      # to set a lower value for gpu-memory-utilization bytes to avoid OOMs
      - op: add
        path: /spec/leaderWorkerTemplate/workerTemplate/spec/containers/0/env/-
        value:
          name: KV_CACHE_MEMORY_BYTES
          value: "63000000000"
      - op: add
        path: /spec/leaderWorkerTemplate/workerTemplate/spec/containers/0/env/-
        value:
          name: VLLM_MPC_NETWORKS
          value: "rdma-0,rdma-1,rdma-2,rdma-3,rdma-4,rdma-5,rdma-6,rdma-7"
  - target:
      kind: LeaderWorkerSet
      name: wide-ep-llm-d-prefill
    patch: |-
      - op: add
        path: /spec/leaderWorkerTemplate/workerTemplate/spec/containers/0/env/-
        value:
          name: VLLM_MPC_NETWORKS
          value: "rdma-0,rdma-1,rdma-2,rdma-3,rdma-4,rdma-5,rdma-6,rdma-7"
